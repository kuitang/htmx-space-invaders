<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Invaders HTMX</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="game-wrapper" hx-ext="ws" ws-connect="/game">
        <div id="game-container">
            <div id="hud">
                <div class="hud-line">Score: <span id="score-value">0</span></div>
                <div class="hud-line">Session: <span id="session-id-value"></span></div>
            </div>
            <div id="metrics">
                <div>S: <span id="server-fps-value">0</span></div>
                <div>C: <span id="client-fps-value">0</span></div>
                <div>L: <span id="latency-value">0</span>ms</div>
            </div>
            <div id="sprite-layer">
                <img id="spaceship-sprite" class="sprite" src="/static/spaceship.svg" alt="Spaceship" width="32" height="32">
                <img id="alien-sprite" class="sprite" src="/static/alien.svg" alt="Alien" width="32" height="32">
                <div id="bullet-layer"></div>
            </div>
            <div id="game-overlay" class="game-overlay">
                <div class="game-over-text">GAME OVER</div>
            </div>
        </div>

        <style id="sprite-style"></style>
        <div id="frame-info" data-frame-id="0"></div>

        <div class="control-area" id="controls">
            <div class="control-left">
                <button class="control-btn" id="left-btn">
                    <img src="/static/arrow-left.svg" alt="Left" style="width: 24px; height: 24px;">
                </button>
                <button class="control-btn" id="right-btn">
                    <img src="/static/arrow-right.svg" alt="Right" style="width: 24px; height: 24px;">
                </button>
            </div>
            <div class="control-right">
                <button class="control-btn fire-btn" id="fire-btn">
                    <img src="/static/crosshair.svg" alt="Fire" style="width: 24px; height: 24px;">
                </button>
            </div>
        </div>

        <form id="left-down" ws-send style="display:none;"></form>
        <form id="left-up" ws-send style="display:none;"></form>
        <form id="right-down" ws-send style="display:none;"></form>
        <form id="right-up" ws-send style="display:none;"></form>
        <form id="fire-down" ws-send style="display:none;"></form>

        <form id="key-left-down" ws-send hx-trigger="keydown[key=='ArrowLeft'] from:body" style="display:none;"></form>
        <form id="key-left-up" ws-send hx-trigger="keyup[key=='ArrowLeft'] from:body" style="display:none;"></form>
        <form id="key-right-down" ws-send hx-trigger="keydown[key=='ArrowRight'] from:body" style="display:none;"></form>
        <form id="key-right-up" ws-send hx-trigger="keyup[key=='ArrowRight'] from:body" style="display:none;"></form>
        <form id="key-shoot" ws-send hx-trigger="keydown[key==' '] from:body" style="display:none;"></form>
    </div>

    <script src="https://unpkg.com/htmx.org@2.0.0/dist/htmx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/htmx-ext-ws@2.0.2"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        function currentFrameId() {
            var frameInfo = document.getElementById('frame-info');
            return frameInfo ? (frameInfo.dataset.frameId || '') : '';
        }

        function wireForm(id, action, type) {
            var form = document.getElementById(id);
            if (!form) {
                return;
            }
            form.addEventListener('htmx:wsConfigSend', function(e) {
                var frameId = currentFrameId();
                var message = { action: action, HEADERS: e.detail.headers };
                if (type) {
                    message.type = type;
                }
                if (frameId) {
                    message.frameId = frameId;
                }
                e.detail.messageBody = JSON.stringify(message);
            });
        }

        [
            ['key-left-down', 'left', 'keydown'],
            ['key-left-up', 'left', 'keyup'],
            ['key-right-down', 'right', 'keydown'],
            ['key-right-up', 'right', 'keyup'],
            ['key-shoot', 'shoot', 'keydown'],
            ['left-down', 'left', 'keydown'],
            ['left-up', 'left', 'keyup'],
            ['right-down', 'right', 'keydown'],
            ['right-up', 'right', 'keyup'],
            ['fire-down', 'shoot', 'keydown']
        ].forEach(function(entry) {
            wireForm(entry[0], entry[1], entry[2]);
        });

        document.body.classList.add('mobile');
        var controls = document.getElementById('controls');
        if (controls) {
            controls.style.display = 'flex';
        }

        function setupTouchControl(btnId, actionName) {
            var btn = document.getElementById(btnId);
            var downForm = document.getElementById(actionName + '-down');
            var upForm = document.getElementById(actionName + '-up');

            if (!btn || !downForm) {
                return;
            }

            ['touchstart', 'mousedown'].forEach(function(evt) {
                btn.addEventListener(evt, function(e) {
                    e.preventDefault();
                    htmx.trigger(downForm, 'submit');
                });
            });

            ['touchend', 'mouseup', 'touchcancel', 'mouseleave'].forEach(function(evt) {
                btn.addEventListener(evt, function(e) {
                    e.preventDefault();
                    if (actionName !== 'fire' && upForm) {
                        htmx.trigger(upForm, 'submit');
                    }
                });
            });
        }

        setupTouchControl('left-btn', 'left');
        setupTouchControl('right-btn', 'right');
        setupTouchControl('fire-btn', 'fire');

        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });
    });
    </script>
</body>
</html>
